#!/bin/bash

clear

echo "Enter IP address to be scanned"

LOCAL=$(ifconfig eth0 $INT |grep "inet addr:" |cut -d ":" -f 2 |awk '{ print $1 }')

echo -e "Your local IP address is:  \e[1;33m"$LOCAL"\e[00m"

echo -e "\e[1;31m--------------------------------------------------\e[00m"
echo "Enter the reference or client name for the scan"
echo -e "\e[1;31m--------------------------------------------------\e[00m"
read -ep "> " NAME

echo ""
echo -e "\e[1;31m-------------------------------------------------------------------\e[00m"
echo "Enter the IP address/Range or subnet you want to scan i.e. 192.168.1.1-10, 192.168.1.1/24"
echo -e "\e[1;31m-------------------------------------------------------------------\e[00m"
read -ep "> " TARGET


mkdir "$NAME" >/dev/null 2>&1
cd "$NAME"
echo ""
echo "$TARGET" > TARGET

echo -e "Target to Scan is: \e[1;31m"$TARGET"\e[00m"

echo -e "\e[1;31m-----------------------------------------------------------------------------------------------------------\e[00m"
echo "Do you want to exclude any IPs from the scan i.e your Windows host? - Enter yes or no and press ENTER"
echo -e "\e[1;31m-----------------------------------------------------------------------------------------------------------\e[00m"
read -ep "> " EXCLUDEANS

clear

if [ $EXCLUDEANS = yes ]
		then
			echo ""
			echo -e "\e[1;31m------------------------------------------------------------------------------------------\e[00m"
			echo "Enter the IP addresses to exclude i.e 192.168.1.1, 192.168.1.1-10"
			echo -e "\e[1;31m------------------------------------------------------------------------------------------\e[00m"
			read -ep "> " EXCLUDEIPS
			EXCLUDE="--exclude "$EXCLUDEIPS""
			echo "$EXCLUDE" > excludetmp
			echo "This following IP addresses were asked to be excluded from the scan = "$EXCLUDEIPS"" > "$NAME"_excluded_IPs.txt
		else
			EXCLUDE=""
			echo "$EXCLUDE" > excludetmp
fi

echo $TARGET |grep "[0-9]" >/dev/null 2>&1

if [ $? = 0 ]
	then
		echo ""
		echo -e "\e[1;33mScan will now start...\e[00m"
		echo ""
		echo -e "\e[1;33m$NAME - Finding Live hosts, please wait...\e[00m"
		nmap -sn $EXCLUDE -v -oA "$NAME"_nmap_PingScan $TARGET >/dev/null
		cat "$NAME"_nmap_PingScan.gnmap | grep "Up" |awk '{print $2" "$3}' > "$NAME"_hosts_Up.txt
		cat "$NAME"_nmap_PingScan.gnmap | grep "Down" |awk '{print $2}' > "$NAME"_hosts_Down.txt
fi

HOSTSCOUNT=$(cat "$NAME"_hosts_Up.txt |wc -l)
HOSTSUPCHK=$(cat "$NAME"_hosts_Up.txt)

# Check if no hosts are up i.r responded to ping requests
if [ -z "$HOSTSUPCHK" ]
	then
		echo ""
		echo -e "\e[1;33mThere are no live hosts present in the range specified. Running ARP Scan to verify\e[00m"
		echo ""
		sleep 4
		arp-scan --file "$NAME"_hosts_Down.txt > "$NAME"_arp_scan.txt 2>&1
		arp-scan --file "$NAME"_hosts_Down.txt |grep -i "0 responded" >/dev/null 2>&1
			if [ $? = 0 ]
				then
					echo -e "\e[1;31mNo live hosts were found using arp-scan - check IP range/source address and try again. It may be there are no live hosts.\e[00m"
					echo ""
			else
					arp-scan --file "$NAME"_hosts_Down.txt > "$REF"_arp_scan.txt 2>&1
					ARPUP=$(cat "$NAME"_arp_scan.txt)
					echo ""
					echo -e "\e[1;33mNmap didn't find any live hosts, but apr-scan found the following hosts within the range...script will exit. Try adding these to the host list to scan.\e[00m"
					echo ""
					
					echo -e "\e[00;32m$ARPUP\e[00m"
					echo ""
					exit 1
	fi
fi

clear

echo -e "\e[1;33m-----------------------------------------------------------------\e[00m"
echo "The following hosts were found up for $NAME"
echo -e "\e[1;33m-----------------------------------------------------------------\e[00m"
HOSTSUP=$(cat "$NAME"_hosts_Up.txt)
echo -e "\e[00;32m$HOSTSUP\e[00m"
echo ""

while true; do 

	echo -e "\e[1;31m----------------------------------------\e[00m"
			echo -e "\e[1;33mEnter the IP address or the domain to scan from the list of live hosts\e[00m"
			read -ep "> " IP

			mkdir "$IP" >/dev/null 2>&1
			cd "$IP"

			echo -e "\e[1;33mChoose one of the following options. Input:\e[00m"

			echo "1. To Gather Information"
			echo "2. To Scan the WebServer"
			echo "3. To Manually Assess the Target"
			echo "4. To Automatically Assess the Target"

			read -ep "> " SCANANS
	
			case $SCANANS in 
				1) source ../../recon.sh $IP
				;;				
				2) source ../../vuln_scan.sh $IP
				;;
				3) source ../../manual_assess.sh $IP
				;;
				4) source ../../auto_assess.sh $IP
				;;
			esac
done

sleep 3

echo -e "\e[1;31m-----------------------------------------------------------------\e[00m"



